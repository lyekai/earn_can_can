<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²“å’ªå¤§æˆ°è‹±èªéŠæˆ²</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- å·¦ä¸Šè§’ä½¿ç”¨è€… -->
    <div class="user-box" id="userBox">ğŸ‘¤ è¨ªå®¢</div>

    <!-- å³ä¸Šè§’ç™»å…¥/ç™»å‡ºæŒ‰éˆ• -->
    <div class="login-btn" id="loginBtn" onclick="handleLoginBtn()">ç™»å…¥</div>

    <div class="main">
        <div class="container">
            <a id='earn' href="earn" class="card">
                <img src="/static/image/can.png" alt="ç½ç½">
                <p>è³ºç½ç½</p>
            </a>
            <a href="/gachapon" class="card">
                <img src="/static/image/gachapon.png" alt="è½‰è›‹">
                <p>è½‰è›‹</p>
            </a>
            <div class="card">
                <img src="/static/image/catnip.png" alt="èƒŒåŒ…">
                <p>èƒŒåŒ…</p>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <img src="/static/image/kamadodo.png" alt="æ¢éšª">
                <p>æ¢éšª</p>
            </div>
            <div class="card">
                <img src="/static/image/team.png" alt="éšŠä¼ç·¨æˆ">
                <p>éšŠä¼ç·¨æˆ</p>
            </div>
            <div class="card">
                <img src="/static/image/battle.png" alt="æˆ°é¬¥é–‹å§‹">
                <p>æˆ°é¬¥é–‹å§‹</p>
            </div>
        </div>
    </div>

    <!-- ç™»å…¥/è¨»å†Šå½ˆå‡ºè¦–çª— -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <span class="close-btn" onclick="closeLogin()">&times;</span>
            <h2 id="modalTitle">ç™»å…¥å¸³è™Ÿ</h2>
            <input type="text" id="loginAccount" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±">
            <input type="password" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼">
            <button class="login-submit" id="loginSubmit">ç™»å…¥</button>
            <div class="register-link" id="registerLink">
                è‹¥ç„¡å¸³è™Ÿï¼Œ<a href="#" onclick="switchToRegister()">é»æˆ‘è¨»å†Š</a>
            </div>
        </div>
    </div>

    <script>
        let isRegisterMode = false; // è¨»å†Šæ¨¡å¼é–‹é—œ

        // åˆ‡æ›åˆ°è¨»å†Šç•«é¢
        function switchToRegister() {
            isRegisterMode = true;
            document.getElementById("modalTitle").innerText = "è¨»å†Šå¸³è™Ÿ";
            document.getElementById("loginSubmit").innerText = "è¨»å†Š";
            document.getElementById("loginAccount").placeholder = "è¨­å®šä½ çš„æš±ç¨±(ä¸è¶…éåå€‹å­—)";
            document.getElementById("loginPassword").placeholder = "è¨­å®šå¯†ç¢¼";
        }

        // é–‹å•Ÿç™»å…¥è¦–çª—ï¼Œé‡ç½®ç‚ºç™»å…¥æ¨¡å¼
        function openLogin() {
            isRegisterMode = false;
            document.getElementById("modalTitle").innerText = "ç™»å…¥å¸³è™Ÿ";
            document.getElementById("loginSubmit").innerText = "ç™»å…¥";
            document.getElementById("loginAccount").placeholder = "è¼¸å…¥ä½ çš„æš±ç¨±";
            document.getElementById("loginPassword").placeholder = "è¼¸å…¥å¯†ç¢¼";
            document.getElementById("loginModal").style.display = "flex";
        }

        // é—œé–‰å½ˆçª—æ™‚é‡ç½®æ¨¡å¼
        function closeLogin() {
            document.getElementById("loginModal").style.display = "none";
            isRegisterMode = false;
            document.getElementById("modalTitle").innerText = "ç™»å…¥å¸³è™Ÿ";
            document.getElementById("loginSubmit").innerText = "ç™»å…¥";
            document.getElementById("loginAccount").placeholder = "è¼¸å…¥ä½ çš„æš±ç¨±";
            document.getElementById("loginPassword").placeholder = "è¼¸å…¥å¯†ç¢¼";
        }

        // é»æ“ŠèƒŒæ™¯å€åŸŸé—œé–‰è¦–çª—
        window.onclick = function(event) {
            const modal = document.getElementById("loginModal");
            if (event.target === modal) closeLogin();
        }

        // ç™»å…¥/è¨»å†ŠæŒ‰éˆ•äº‹ä»¶
        document.getElementById("loginSubmit").addEventListener("click", async function() {
            const account = document.getElementById("loginAccount").value.trim();
            const password = document.getElementById("loginPassword").value.trim();

            if (account === "" || password === "") {
                alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
                return;
            }

            // è¨»å†Šå‰ç«¯æª¢æŸ¥æš±ç¨±é•·åº¦
            if (isRegisterMode && account.length > 10) {
                alert("æš±ç¨±ä¸å¯è¶…é10å€‹å­—ï¼Œè¨»å†Šå¤±æ•—");
                return;
            }

            try {
                if (isRegisterMode) {
                    // è¨»å†Š API
                    const res = await fetch('/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: account, password: password })
                    });
                    const result = await res.json();

                    if (result.success) {
                        alert("è¨»å†ŠæˆåŠŸï¼Œå·²è‡ªå‹•ç™»å…¥ï¼");
                        localStorage.setItem("userAccount", result.username);
                        updateUserUI(result.username);
                        closeLogin();
                    } else {
                        alert(result.message || "è¨»å†Šå¤±æ•—");
                    }
                } else {
                    // ç™»å…¥ API
                    const res = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: account, password: password })
                    });
                    const result = await res.json();

                    if (result.success) {
                        localStorage.setItem("userAccount", result.username);
                        updateUserUI(result.username);
                        closeLogin();
                    } else {
                        alert(result.message || "ç™»å…¥å¤±æ•—");
                    }
                }
            } catch (err) {
                console.error(err);
                alert("ä¼ºæœå™¨é€£ç·šéŒ¯èª¤");
            }
        });

        // ç™»å‡º
        function logout() {
            localStorage.removeItem("userAccount");
            updateUserUI(null);
        }

        // æ›´æ–° UI
        function updateUserUI(account) {
            const userBox = document.getElementById("userBox");
            const loginBtn = document.getElementById("loginBtn");

            if (account) {
                userBox.textContent = `å—¨ï¼Œ${account}ï¼`;
                loginBtn.textContent = "ç™»å‡º";
                loginBtn.onclick = logout;
            } else {
                userBox.textContent = "ğŸ‘¤ è¨ªå®¢";
                loginBtn.textContent = "ç™»å…¥";
                loginBtn.onclick = openLogin;
            }
        }

        // åˆå§‹æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.addEventListener("load", function() {
            const savedAccount = localStorage.getItem("userAccount");
            updateUserUI(savedAccount);
        });

        // å‹•æ…‹ç¶å®šç™»å…¥æŒ‰éˆ•ï¼ˆåˆå§‹ï¼‰
        function handleLoginBtn() {
            const account = localStorage.getItem("userAccount");
            if (account) logout();
            else openLogin();
        }
    </script>
</body>
</html>
