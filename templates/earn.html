<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³ºç½ç½ - è‹±æ–‡å–®å­—æŒ‘æˆ°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='earn.css') }}">
</head>
<body>
    <!-- ğŸ” ä¸Šæ–¹æ§åˆ¶åˆ— -->
    <div class="top-bar">
        <div class="back-container">
            <a href="/" class="back-btn">â† å›ä¸Šé </a>

            <!-- ğŸ“‚ å–®å­—æª”é¸æ“‡ -->
            <select id="wordset-select" onchange="changeWordset()" class="wordset-dropdown">
                <option value="junior" {% if selected_file == "junior" %}selected{% endif %}>åœ‹ä¸­2000å–®å­—</option>
                <option value="senior" {% if selected_file == "senior" %}selected{% endif %}>é«˜ä¸­5000å–®å­—</option>
            </select>
        </div>

        <div class="status-container">
            <div class="status-box">
                <img src="/static/image/battle.png" alt="çµ±ç‡åŠ›" class="status-icon">
                <span id="leadership">10</span>
                <span id="timer" style="font-size:14px; color:#555; margin-left:5px;"></span>
            </div>
            <div class="status-box">
                <img src="/static/image/can.png" alt="ç½é ­" class="status-icon">
                <span id="canCount">0</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ğŸ® å·¦é‚ŠéŠæˆ²å€ -->
        <div class="game-area">
            <h2 class="question" id="question">{{ question }}</h2>

            <div class="options">
                <button class="option-btn" onclick="selectOption(1, this)">{{ option1 }}</button>
                <button class="option-btn" onclick="selectOption(2, this)">{{ option2 }}</button>
                <button class="option-btn" onclick="selectOption(3, this)">{{ option3 }}</button>
                <button class="option-btn" onclick="selectOption(4, this)">{{ option4 }}</button>
            </div>

            <div class="game-buttons">
                <button id="confirm-btn" class="action-btn" style="display: none;" onclick="confirmAnswer()">ç¢ºèª</button>
                <button id="next-btn" class="action-btn" style="display: none;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <!-- ğŸ± è²“å’ªå°è©±å€ -->
        <div class="cat-area">
            <div class="cat-dialog">
                <p id="cat-text">å–®å­—æœƒèƒŒå›ä½ ï¼Œä½†ç½ç½ä¸æœƒå–µï½</p>
            </div>
            <img src="/static/image/sticker_1.png" alt="è²“å’ª" class="cat-img">
        </div>
    </div>

    <script>
        let selectedOption = null;
        const correctAnswer = {{ correct_answer }};
        let isAnswered = false;

        // âš™ï¸ åˆå§‹åŒ– localStorage ç‹€æ…‹
        let leadership = parseInt(localStorage.getItem("leadership") || "10");
        let canCount = parseInt(localStorage.getItem("canCount") || "0");
        let lastRecover = parseInt(localStorage.getItem("lastRecover") || Date.now());
        const RECOVER_INTERVAL = 600000; // æ¯600ç§’æ¢å¾©1é»
        let username = localStorage.getItem("userAccount"); // ç™»å…¥å¾Œå­˜çš„å¸³è™Ÿ

        if (username) {
            // ç™»å…¥ä½¿ç”¨è€… â†’ å¾å¾Œç«¯è®€å–
            fetch("/get_cans", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({username})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    canCount = data.cans;
                    localStorage.setItem("canCount", canCount);
                    updateStatus();
                }
            });
        } else {
            // è¨ªå®¢ â†’ ä¸è®€å– localStorageï¼Œåˆ·æ–°å°±æ­¸é›¶
            canCount = 0;
            updateStatus();
        }

        // ğŸ•’ é›¢ç·šæœŸé–“è‡ªå‹•è£œç®—çµ±ç‡åŠ›
        const now = Date.now();
        const diff = now - lastRecover;
        if (diff > RECOVER_INTERVAL && leadership < 10) {
            const recovered = Math.floor(diff / RECOVER_INTERVAL);
            leadership = Math.min(10, leadership + recovered);
            lastRecover = now - (diff % RECOVER_INTERVAL);
            saveStatus();
        }

        updateStatus();

        // ğŸ§­ çµ±ç‡åŠ›å€’æ•¸èˆ‡è‡ªå‹•å›å¾©
        setInterval(() => {
            const now = Date.now();
            const elapsed = now - lastRecover;
            const remaining = Math.max(0, RECOVER_INTERVAL - elapsed);

            if (leadership >= 10) {
                // çµ±ç‡åŠ›æ»¿æ™‚é¡¯ç¤ºå·²æ»¿
                document.getElementById("timer").innerText = "ï¼ˆå·²æ»¿ï¼‰";
            } else {
                // å€’æ•¸é¡¯ç¤º
                const min = Math.floor(remaining / 60000);
                const sec = Math.floor((remaining % 60000) / 1000);
                document.getElementById("timer").innerText =
                    `ï¼ˆä¸‹æ¬¡å›å¾©ï¼š${min}:${sec.toString().padStart(2,'0')}ï¼‰`;

                // è‡ªå‹•æ¢å¾©
                if (remaining <= 0) {
                    leadership++;
                    lastRecover = Date.now();
                    animateRecovery();
                    saveStatus();
                    updateStatus();
                    document.getElementById("cat-text").innerText = "çµ±ç‡åŠ›æ¢å¾©å•¦ï½å–µğŸ’ª";
                }
            }
        }, 1); // ä¿ç•™1æ¯«ç§’ï¼Œç«‹å³å•Ÿå‹•å€’æ•¸

        function changeWordset() {
            const select = document.getElementById("wordset-select");
            const selectedValue = select.value;

            // åˆ‡æ›ä¸åŒè³‡æ–™é›†
            // é€™é‚Šé‡æ–°å°å‘åˆ°ç›¸åŒé é¢ï¼Œä½†åŠ ä¸Š ?file=junior æˆ– ?file=senior
            window.location.href = `/earn?file=${selectedValue}`;
        }


        // ğŸ’¾ å„²å­˜ç‹€æ…‹ (localStorage + å¾Œç«¯)
        function saveStatus() {
            localStorage.setItem("leadership", leadership);
            localStorage.setItem("canCount", canCount);
            localStorage.setItem("lastRecover", lastRecover);

            if (username) {
                fetch("/update_cans", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({username, cans: canCount})
                })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) console.warn("ç½é ­æ•¸æ›´æ–°å¤±æ•—:", data.message);
                });
            }
        }

        // ğŸ“Š æ›´æ–°é¡¯ç¤º
        function updateStatus() {
            document.getElementById("leadership").innerText = leadership;
            document.getElementById("canCount").innerText = canCount;
        }

        // âœ¨ çµ±ç‡åŠ›æ¢å¾©å‹•ç•«
        function animateRecovery() {
            const el = document.getElementById("leadership");
            el.style.transition = "all 0.3s ease";
            el.style.transform = "scale(1.4)";
            el.style.color = "#2ecc71";
            setTimeout(() => {
                el.style.transform = "scale(1)";
                el.style.color = "#000";
            }, 300);
        }

        // ğŸ”’ ç¦ç”¨æŒ‰éˆ•
        function disableAll() {
            document.querySelectorAll(".option-btn, #confirm-btn, #next-btn").forEach(b => {
                b.disabled = true;
                b.style.opacity = 0.6;
            });
        }

        // ğŸ”“ å•Ÿç”¨æŒ‰éˆ•
        function enableAll() {
            document.querySelectorAll(".option-btn, #confirm-btn, #next-btn").forEach(b => {
                b.disabled = false;
                b.style.opacity = 1;
            });
        }

        // ğŸ¯ é¸æ“‡é¸é …
        function selectOption(choice, btn) {
            if (leadership <= 0) {
                document.getElementById("cat-text").innerText = "æ²’åŠ›æ°£äº†å–µï½ä¼‘æ¯ä¸€æœƒå§ ğŸ˜¿";
                return;
            }
            if (isAnswered) return;

            selectedOption = choice;
            document.querySelectorAll(".option-btn").forEach(b => b.style.background = "#fff");
            btn.style.background = "#ffe08a";

            document.getElementById("confirm-btn").style.display = "inline-block";
            document.getElementById("next-btn").style.display = "none";
        }

        // âœ… ç¢ºèªç­”æ¡ˆ
        function confirmAnswer() {
            if (selectedOption === null || leadership <= 0) return;

            const catText = document.getElementById("cat-text");
            const confirmBtn = document.getElementById("confirm-btn");
            const optionButtons = document.querySelectorAll(".option-btn");

            isAnswered = true;
            optionButtons.forEach(b => b.disabled = true);

            optionButtons.forEach((b, index) => {
                const num = index + 1;
                if (num === correctAnswer) b.style.background = "#b6fcb6";
                else if (num === selectedOption) b.style.background = "#fcb6b6";
                else b.style.background = "#fff";
            });

            if (selectedOption === correctAnswer) {
                const gain = Math.floor(Math.random() * 5) + 1;
                canCount += gain;
                catText.innerText = `å–µå–µï¼ç­”å°äº†ï¼ä½ ç²å¾— ${gain} ç½ç½ ğŸ¥«`;
            } else {
                const prevLeadership = leadership;
                leadership = Math.max(0, leadership - 1);

                // âš™ï¸ åªæœ‰å¾æ»¿è¡€æ‰ä¸‹ä¾†æ™‚ï¼Œæ‰é‡è¨­å€’æ•¸èµ·é»
                if (prevLeadership === 10) {
                    lastRecover = Date.now();
                }

                catText.innerText = "å—šå—šï½ç­”éŒ¯äº†ï¼Œçµ±ç‡åŠ›æ¸› 1 ğŸ˜¿";
            }

            saveStatus();
            updateStatus();

            confirmBtn.style.display = "none";
            document.getElementById("next-btn").style.display = "inline-block";

            if (leadership <= 0) setTimeout(() => {
                disableAll();
                catText.innerText = "æ²’åŠ›æ°£äº†å–µï½ä¼‘æ¯ä¸€æœƒå§ ğŸ˜¿";
            }, 400);
        }

        // ğŸ” ä¸‹ä¸€é¡Œ
        function nextQuestion() {
            saveStatus();
            window.location.reload();
        }
    </script>
</body>
</html>